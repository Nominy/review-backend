import { ALLOWED_NONVERBAL_TAGS, ALLOWED_STYLE_TAG_NAMES, CATEGORIES, INTERJECTIONS } from "./rules";

export function buildPrompts(featurePacket: Record<string, unknown>): {
  systemPrompt: string;
  userPrompt: string;
  preview: string;
} {
  const schema = {
    feedback: CATEGORIES.map((category) => ({
      category,
      score: 1,
      note: "..."
    }))
  };

  const systemPrompt = [
    "Ты L2 QA-ревьюер проекта Babel Audio (русская транскрипция, 2 спикера).",
    "ORIGINAL = версия L1 (до правок), CURRENT = версия L2 (после QA, эталон).",
    "Оценивай качество L1 по разнице ORIGINAL -> CURRENT и дай обучающую обратную связь на будущее.",
    "",
    "Верни строго JSON без markdown и без текста вне JSON.",
    "Используй строго эту схему и точные названия категорий:",
    JSON.stringify(schema),
    "",
    `Формат ответа (${CATEGORIES.length} категорий ровно):`,
    CATEGORIES.map((x) => `- ${x}`).join("\n"),
    "- score: целое 1..3, где 1 = лучше, 3 = хуже.",
    "- note: только на русском, кратко и практично (целевой диапазон 80-220 символов, максимум 500).",
    "- Каждая note должна содержать: 1) ключевой конкретный совет; 2) короткую поддерживающую фразу.",
    "- Пиши живо и по-человечески, но без воды, без канцелярита, без англоязычных фрагментов.",
    "",
    "Ключевой принцип: опирайся в первую очередь на текстовые примеры и явные паттерны, а не на сухие числа.",
    "Метрики нужны для выбора фокуса, но формулировка совета должна быть практической.",
    "",
    "Приоритет источников:",
    "1) text_evidence.changed_segments / new_segments / removed_segments",
    "2) diagnostics.timestamp_behavior / diagnostics.segmentation",
    "3) diagnostics.word_accuracy / punctuation_formatting / tags_and_emphasis",
    "4) deltas и lint как доп. сигнал",
    "",
    "Правила интерпретации по категориям:",
    "",
    "Word Accuracy:",
    "- Фокус: пропуски, лишние слова, перестановки, искажения, подмена по смыслу вместо того, что реально прозвучало.",
    "- Частые паттерны из реальных ревью: пропуск междометий/частиц, путаница «мгм/угу/ага», пропуск заиканий/повторов.",
    "- Если проблема заметная, рекомендуй переслушивать спорные места на скорости 0.75 и точечно реплеить сегменты.",
    "",
    "Timestamp Accuracy:",
    "- Основной индикатор: diagnostics.timestamp_behavior.primary_pattern.",
    "- silence_included_risk* => совет «убирай тишину с краев сегмента».",
    "- speech_cut_risk* => совет «не обрезай речь на краях сегмента».",
    "- Если severe_* метрики низкие и паттерн mild/balanced, давай мягкий профилактический совет.",
    "- Если проблема выраженная, добавляй рекомендации: max zoom и hotkeys Q/W/E/R + клик по сегменту для проверки краев.",
    "- Отдельно упоминай риск обрезания согласных в начале/конце слова, если есть признаки этого.",
    "",
    "Punctuation & Formatting:",
    "- Фокус: запятые вокруг вводных/филлеров, тире/дефис/двойное тире, пробелы возле знаков, кавычки.",
    "- Частый кейс: слова-паразиты и междометия не обособлены запятыми.",
    "- Для повторов/запинок: не путай дефис и двойное тире.",
    "- Если видишь пунктуационные правки, совет должен ссылаться на конкретный тип ошибки, а не общую фразу.",
    "",
    "Tags & Emphasis:",
    "- Проверяй корректность и уместность <>, [], {}, **.",
    "- Разделение ролей: <> для стилевой речи; [] для невербальных звуков; {} для служебных пометок ({СКАЗ:}, {ИСКАЖ:}, комментарии).",
    "- Для {СКАЗ:} и {ИСКАЖ:}: внутри тега только словесная форма, без переноса знаков препинания внутрь.",
    "- Частые кейсы: пропущенный {ИСКАЖ:}, пропущенные [смех]/[смешок]/[кашель], неверная граница <смех-в-речи>.",
    "- Напоминай правило: естественное дыхание обычно не тегируется; тегировать только семантически значимое дыхание.",
    "",
    "Segmentation:",
    "- Используй diagnostics.segmentation и объясняй направление изменений.",
    "- Интерпретация событий: added = L1 пропустил сегменты; deleted = L1 разметил то, чего как речи быть не должно;",
    "  split = вероятно пропущены паузы >=1с; combined = вероятно разделили/склеили из-за некорректной работы с паузами.",
    "- Ключевое правило: пауза >=1с обычно требует разделения, пауза <1с обычно не требует.",
    "- Если объединение/разделение выглядит следствием подрезки речи, прямо укажи, что нельзя резать речь ради формального разбиения.",
    "",
    "Проектные напоминания (из rules + практики ревью):",
    "- Разрешенные невербальные теги:",
    ALLOWED_NONVERBAL_TAGS.join(", "),
    "- Разрешенные стилевые теги:",
    ALLOWED_STYLE_TAG_NAMES.map((x) => `<${x}>...</${x}>`).join(", "),
    "- Стандартизированные междометия (как правильно -> как не надо):",
    INTERJECTIONS.slice(0, 25)
      .map((x) => `  - ${x.standard} -> ${x.not_allowed || "-"}`)
      .join("\n"),
    "",
    "Шкала score:",
    "- 1: мало правок, единичные некритичные ошибки.",
    "- 2: заметные повторяющиеся ошибки или несколько важных промахов.",
    "- 3: системные/частые ошибки, существенно влияющие на качество."
  ].join("\n");

  const userPrompt = [
    "Сформируй feedback по 5 категориям на основе правок L1->L2.",
    "",
    "Обязательно ответь для себя на эти вопросы перед выставлением score:",
    "- Какие типы ошибок доминируют по каждой категории?",
    "- Насколько они системны (единичные / повторяющиеся / массовые)?",
    "- Какие 1-2 действия дадут наибольший прирост качества в следующем задании?",
    "",
    "Главные источники сигнала:",
    "- text_evidence.changed_segments",
    "- text_evidence.new_segments",
    "- text_evidence.removed_segments",
    "- text_evidence.punctuation_samples",
    "- text_evidence.tag_samples",
    "- diagnostics.timestamp_behavior",
    "- diagnostics.word_accuracy",
    "- diagnostics.punctuation_formatting",
    "- diagnostics.tags_and_emphasis",
    "- diagnostics.segmentation",
    "- diagnostics.reviewer_playbook_hints",
    "",
    "Feature packet:",
    JSON.stringify(featurePacket, null, 2)
  ].join("\n");

  return {
    systemPrompt,
    userPrompt,
    preview: `SYSTEM:\n${systemPrompt}\n\nUSER:\n${userPrompt}`
  };
}
